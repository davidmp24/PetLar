{% extends 'index.html' %}

{% block title %}Cadastrar Novo Adotante - PetLar{% endblock %}
{% block page_title %}Cadastro de Adotante{% endblock %}

{% block head_extra %}
    {{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
    <style>
        #mapAdotante { /* ID único para o mapa do adotante */
            height: 350px;
            width: 100%;
            margin-bottom: 15px;
            border: 1px solid #555;
            background-color: #444;
            border-radius: 5px;
        }
        .preview-image-container img {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center text-light">Cadastro de Adotante</h2>
    <div class="card p-4 shadow-lg bg-dark text-light">
        <form method="POST" enctype="multipart/form-data" id="adotante-form">
            <!-- Informações Pessoais -->
            <h4 class="text-light">Informações Pessoais</h4>
            <div class="mb-3">
                <label for="nome_completo" class="form-label">Nome Completo</label>
                <input type="text" class="form-control bg-secondary text-light" id="nome_completo" name="nome_completo" required value="{{ form_data.get('nome_completo', '') if form_data else '' }}">
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="rg" class="form-label">RG</label>
                    <input type="text" class="form-control bg-secondary text-light" id="rg" name="rg" required value="{{ form_data.get('rg', '') if form_data else '' }}">
                </div>
                <div class="col-md-6">
                    <label for="cpf" class="form-label">CPF</label>
                    <input type="text" class="form-control bg-secondary text-light" id="cpf" name="cpf" required value="{{ form_data.get('cpf', '') if form_data else '' }}">
                    {# <div id="cpf-error" class="text-danger"></div> Adicionar JS para validar se necessário #}
                </div>
            </div>

            <!-- Informações de Contato (Endereço Principal) -->
            <h4 class="text-light mt-4">Endereço Principal (Para Correspondência)</h4>
             <div class="row mb-3 align-items-end">
                <div class="col-md-6">
                    <label for="cep" class="form-label">CEP</label>
                    <input type="text" class="form-control form-control-sm bg-secondary text-light" id="cep" name="cep" required value="{{ form_data.get('cep', '') if form_data else '' }}">
                    <div id="cep-error" class="text-danger"></div>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-primary w-auto mb-1 btn-sm" onclick="buscarEnderecoPrincipal(document.getElementById('cep').value)">
                        <i class="fas fa-search"></i> Buscar CEP
                    </button>
                </div>
            </div>
            <div class="mb-3">
                <label for="endereco" class="form-label">Logradouro (Rua, Avenida)</label>
                <input type="text" class="form-control bg-secondary text-light" id="endereco" name="endereco" required value="{{ form_data.get('endereco', '') if form_data else '' }}">
            </div>
            <div class="row mb-3">
                 <div class="col-md-6">
                    <label for="bairro" class="form-label">Bairro</label>
                    <input type="text" class="form-control bg-secondary text-light" id="bairro" name="bairro" required value="{{ form_data.get('bairro', '') if form_data else '' }}">
                </div>
                <div class="col-md-6">
                    <label for="cidade" class="form-label">Cidade</label>
                    <input type="text" class="form-control bg-secondary text-light" id="cidade" name="cidade" required value="{{ form_data.get('cidade', '') if form_data else '' }}">
                </div>
            </div>
             <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control bg-secondary text-light" id="email" name="email" required value="{{ form_data.get('email', '') if form_data else '' }}">
            </div>
            <div class="mb-3">
                <label for="telefone" class="form-label">Telefone</label>
                <input type="text" class="form-control bg-secondary text-light" id="telefone" name="telefone" required value="{{ form_data.get('telefone', '') if form_data else '' }}">
            </div>

            <!-- Localização do Adotante no Mapa -->
            <h4 class="text-light mt-4">Localização da Residência (Para Avaliação)</h4>
            <div class="mb-3">
                <label for="address-search-adotante" class="form-label">Buscar Endereço no Mapa</label>
                <div class="input-group">
                    <input type="text" id="address-search-adotante" class="form-control form-control-sm bg-secondary text-light" placeholder="Digite um endereço para centralizar (Ex: Rua Exemplo, Cidade)">
                    <button class="btn btn-primary btn-sm" type="button" id="search-address-button-adotante">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </div>
            <div id="mapAdotante">Carregando mapa...</div>
            <small class="form-text text-muted mb-3 d-block">Clique no mapa para definir a localização ou arraste o marcador.</small>
            <div class="mb-3">
                <label for="localizacao_mapa_texto" class="form-label">Endereço do Mapa (Texto)</label>
                <input type="text" class="form-control bg-secondary text-light" id="localizacao_mapa_texto" name="localizacao_mapa_texto" placeholder="Preenchido pelo mapa ou digite" value="{{ form_data.get('localizacao_mapa_texto', '') if form_data else '' }}">
            </div>
            <input type="hidden" id="latitude_adotante" name="latitude" value="{{ (form_data.get('latitude') if form_data else '') or (initial_map_coords_adotante.lat if initial_map_coords_adotante and initial_map_coords_adotante.lat != -14.2350 else '') }}">
            <input type="hidden" id="longitude_adotante" name="longitude" value="{{ (form_data.get('longitude') if form_data else '') or (initial_map_coords_adotante.lng if initial_map_coords_adotante and initial_map_coords_adotante.lng != -51.9253 else '') }}">


            <!-- Informações sobre Interesse em Adoção -->
            <h4 class="text-light mt-4">Interesse em Adoção</h4>
            <div class="mb-3">
                <label for="animal_interesse" class="form-label">Nome do Animal de Interesse (se houver)</label>
                <input type="text" class="form-control bg-secondary text-light" id="animal_interesse" name="animal_interesse" value="{{ form_data.get('animal_interesse', '') if form_data else '' }}">
            </div>
            <div class="mb-3">
                <label for="tipo_animal_interesse" class="form-label">Tipo de Animal de Interesse</label>
                <select class="form-select bg-secondary text-light" id="tipo_animal_interesse" name="tipo_animal_interesse" required>
                    <option value="" disabled {% if not (form_data and form_data.get('tipo_animal_interesse')) %}selected{% endif %}>Selecione...</option>
                    <option value="Cachorro" {% if form_data and form_data.get('tipo_animal_interesse') == 'Cachorro' %}selected{% endif %}>Cachorro</option>
                    <option value="Gato" {% if form_data and form_data.get('tipo_animal_interesse') == 'Gato' %}selected{% endif %}>Gato</option>
                    <option value="Ave" {% if form_data and form_data.get('tipo_animal_interesse') == 'Ave' %}selected{% endif %}>Ave</option>
                    <option value="Outro" {% if form_data and form_data.get('tipo_animal_interesse') == 'Outro' %}selected{% endif %}>Outro</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="justificativa_adocao" class="form-label">Por que você deseja adotar?</label>
                <textarea class="form-control bg-secondary text-light" id="justificativa_adocao" name="justificativa_adocao" rows="3" required>{{ form_data.get('justificativa_adocao', '') if form_data else '' }}</textarea>
            </div>

            <!-- Questionário -->
            <h4 class="text-light mt-4">Sobre sua Casa e Rotina</h4>
            <div class="mb-3">
                <label class="form-label">Você tem outros animais em casa?</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="tem_outros_animais" id="tem_outros_animais_sim" value="Sim" onclick="mostrarCamposOutrosAnimais()" {% if form_data and form_data.get('tem_outros_animais') == 'Sim' %}checked{% endif %}>
                    <label class="form-check-label" for="tem_outros_animais_sim">Sim</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="tem_outros_animais" id="tem_outros_animais_nao" value="Nao" onclick="esconderCamposOutrosAnimais()" {% if not (form_data and form_data.get('tem_outros_animais') == 'Sim') %}checked{% endif %}>
                    <label class="form-check-label" for="tem_outros_animais_nao">Não</label>
                </div>
            </div>
            <div id="campos_outros_animais" style="display: none;">
                <div class="mb-3">
                    <label for="quantidade_animais" class="form-label">Quantidade de outros animais</label>
                    <input type="number" class="form-control bg-secondary text-light" id="quantidade_animais" name="quantidade_animais" min="1" placeholder="Ex: 2" value="{{ form_data.get('quantidade_animais', '') if form_data else '' }}">
                </div>
                <div class="mb-3">
                    <label for="tipos_animais" class="form-label">Quais tipos de animais você possui?</label>
                    <input type="text" class="form-control bg-secondary text-light" id="tipos_animais" name="tipos_animais" placeholder="Ex: 2 cães e 1 gato" value="{{ form_data.get('tipos_animais', '') if form_data else '' }}">
                </div>
            </div>
            <div class="mb-3">
                <label for="tempo_sozinho" class="form-label">Quantas horas por dia o animal ficaria sozinho?</label>
                <input type="number" class="form-control bg-secondary text-light" id="tempo_sozinho" name="tempo_sozinho" min="0" placeholder="Ex: 4" value="{{ form_data.get('tempo_sozinho', '') if form_data else '' }}">
            </div>

            <!-- Fotos do Adotante -->
            <h4 class="text-light mt-4">Fotos (Opcional)</h4>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="foto_pessoal" class="form-label">Sua Foto Pessoal</label>
                    <input type="file" class="form-control bg-secondary text-light" id="foto_pessoal" name="foto_pessoal" accept="image/*" onchange="previewAdotanteImage(event, 'preview-pessoal-adotante-image', 'preview-pessoal-adotante-container')">
                    <div id="preview-pessoal-adotante-container" class="mt-2 preview-image-container" style="display: none;">
                        <img id="preview-pessoal-adotante-image" src="#" class="img-thumbnail">
                        <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeAdotanteImage('foto_pessoal', 'preview-pessoal-adotante-image', 'preview-pessoal-adotante-container')">Remover</button>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="foto_local" class="form-label">Foto do Local de Habitação</label>
                    <input type="file" class="form-control bg-secondary text-light" id="foto_local" name="foto_local" accept="image/*" onchange="previewAdotanteImage(event, 'preview-local-adotante-image', 'preview-local-adotante-container')">
                     <div id="preview-local-adotante-container" class="mt-2 preview-image-container" style="display: none;">
                        <img id="preview-local-adotante-image" src="#" class="img-thumbnail">
                        <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeAdotanteImage('foto_local', 'preview-local-adotante-image', 'preview-local-adotante-container')">Remover</button>
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="d-flex justify-content-between mt-4">
                 <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus me-1"></i> Cadastrar Adotante</button>
                 <button type="reset" class="btn btn-secondary" onclick="resetAdotanteForm()"><i class="fas fa-eraser me-1"></i> Limpar Formulário</button>
            </div>
         </form>
     </div>
 </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Funções para Preview e Remoção de Imagens (Adotante)
        function previewAdotanteImage(event, previewImageId, previewContainerId) {
            const input = event.target;
            const previewContainer = document.getElementById(previewContainerId);
            const previewImage = document.getElementById(previewImageId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = "block";
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                previewContainer.style.display = "none";
                previewImage.src = "";
            }
        }

        function removeAdotanteImage(inputId, previewImageId, previewContainerId) {
            document.getElementById(inputId).value = "";
            document.getElementById(previewImageId).src = "";
            document.getElementById(previewContainerId).style.display = "none";
        }

        // Funções para campos condicionais "Outros Animais"
        function mostrarCamposOutrosAnimais() {
            document.getElementById('campos_outros_animais').style.display = 'block';
        }
        function esconderCamposOutrosAnimais() {
            const camposDiv = document.getElementById('campos_outros_animais');
            camposDiv.style.display = 'none';
            // Não limpar os valores ao esconder, o backend lida com isso
        }

        // Função de Reset para Formulário do Adotante
        function resetAdotanteForm() {
            const adotanteForm = document.getElementById('adotante-form');
            if(adotanteForm) adotanteForm.reset();

            removeAdotanteImage('foto_pessoal', 'preview-pessoal-adotante-image', 'preview-pessoal-adotante-container');
            removeAdotanteImage('foto_local', 'preview-local-adotante-image', 'preview-local-adotante-container');
            esconderCamposOutrosAnimais(); // Garante que campos condicionais sejam resetados visualmente
            document.getElementById('tem_outros_animais_nao').checked = true; // Define 'Não' como padrão no reset

            // Reseta o mapa do adotante
            if (mapAdotante) {
                mapAdotante.setView([defaultLatAdotante, defaultLngAdotante], defaultZoomAdotante);
                if (markerAdotante) {
                    mapAdotante.removeLayer(markerAdotante);
                    markerAdotante = null;
                }
            }
            document.getElementById('latitude_adotante').value = '';
            document.getElementById('longitude_adotante').value = '';
            document.getElementById('localizacao_mapa_texto').value = '';
            document.getElementById('address-search-adotante').value = '';
        }

        // Variáveis Globais para o Mapa do Adotante
        let mapAdotante;
        let markerAdotante;
        const defaultLatAdotante = -14.2350;
        const defaultLngAdotante = -51.9253;
        const defaultZoomAdotante = 4;
        const selectedZoomAdotante = 16;

        // Função para inicializar o mapa do Adotante
        function initMapAdotante() {
            const formLatValue = document.getElementById('latitude_adotante').value;
            const formLngValue = document.getElementById('longitude_adotante').value;
            const initialLat = (formLatValue && !isNaN(parseFloat(formLatValue))) ? parseFloat(formLatValue) : defaultLatAdotante;
            const initialLng = (formLngValue && !isNaN(parseFloat(formLngValue))) ? parseFloat(formLngValue) : defaultLngAdotante;
            const initialZoomToUse = (initialLat !== defaultLatAdotante || initialLng !== defaultLngAdotante) ? selectedZoomAdotante : defaultZoomAdotante;

            mapAdotante = L.map('mapAdotante').setView([initialLat, initialLng], initialZoomToUse);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(mapAdotante);

            if (initialLat !== defaultLatAdotante || initialLng !== defaultLngAdotante) {
                markerAdotante = L.marker([initialLat, initialLng], { draggable: true }).addTo(mapAdotante);
                markerAdotante.on('dragend', function(event) { updateCoordinatesAdotante(event.target.getLatLng()); });
                updateAddressFieldAdotante(initialLat, initialLng);
                markerAdotante.bindPopup(`Localização atual:<br>Lat: ${initialLat.toFixed(4)}, Lng: ${initialLng.toFixed(4)}`).openPopup();
            }

            mapAdotante.on('click', function(e) {
                const clickedLatLng = e.latlng;
                if (markerAdotante) {
                    markerAdotante.setLatLng(clickedLatLng);
                } else {
                    markerAdotante = L.marker(clickedLatLng, { draggable: true }).addTo(mapAdotante);
                    markerAdotante.on('dragend', function(event) { updateCoordinatesAdotante(event.target.getLatLng()); });
                }
                updateCoordinatesAdotante(clickedLatLng);
            });
        }

        function updateCoordinatesAdotante(latlng) {
            const lat = latlng.lat.toFixed(6);
            const lng = latlng.lng.toFixed(6);
            document.getElementById('latitude_adotante').value = lat;
            document.getElementById('longitude_adotante').value = lng;
            if (markerAdotante) markerAdotante.bindPopup(`Localização selecionada:<br>Lat: ${lat}, Lng: ${lng}`).openPopup();
            updateAddressFieldAdotante(latlng.lat, latlng.lng);
        }

        function updateAddressFieldAdotante(lat, lng) {
             fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    let addressText = `Lat: ${parseFloat(lat).toFixed(4)}, Lng: ${parseFloat(lng).toFixed(4)}`;
                    if (data && data.display_name) {
                        if (data.address) {
                            const ad = data.address;
                            const parts = [ad.road, ad.house_number, ad.suburb || ad.city_district, ad.city || ad.town || ad.village, ad.state, ad.postcode];
                            addressText = parts.filter(part => part).join(', ').replace(/, ,/g, ',').trim();
                            if (!addressText) addressText = data.display_name;
                        } else { addressText = data.display_name; }
                    }
                    document.getElementById('localizacao_mapa_texto').value = addressText;
                })
                .catch(error => {
                    console.error('Erro geocodificação reversa (Adotante):', error);
                    document.getElementById('localizacao_mapa_texto').value = `Lat: ${parseFloat(lat).toFixed(4)}, Lng: ${parseFloat(lng).toFixed(4)} (Erro ao buscar endereço)`;
                });
        }

        // Busca de Endereço para Mapa do Adotante
        document.getElementById('search-address-button-adotante').addEventListener('click', performAddressSearchAdotante);
        document.getElementById('address-search-adotante').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                performAddressSearchAdotante();
            }
        });

        function performAddressSearchAdotante() {
            const query = document.getElementById('address-search-adotante').value.trim();
            if (!query) { alert('Digite um endereço para buscar.'); return; }
            fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        mapAdotante.setView([lat, lon], selectedZoomAdotante);
                        if (markerAdotante) { markerAdotante.setLatLng([lat, lon]); }
                        else {
                            markerAdotante = L.marker([lat, lon], { draggable: true }).addTo(mapAdotante);
                            markerAdotante.on('dragend', function(e) { updateCoordinatesAdotante(e.target.getLatLng()); });
                        }
                        updateCoordinatesAdotante({ lat: lat, lng: lon });
                    } else { alert('Endereço não encontrado.'); }
                })
                .catch(error => { console.error('Erro busca endereço (Adotante):', error); alert('Erro ao buscar endereço.'); });
        }

        // Busca de CEP para Endereço Principal
        function buscarEnderecoPrincipal(cep) {
            const cepLimpo = cep.replace(/\D/g, '');
            if (cepLimpo.length !== 8) { document.getElementById('cep-error').textContent = 'CEP inválido.'; return; }
            document.getElementById('cep-error').textContent = 'Buscando...';
            fetch(`https://brasilapi.com.br/api/cep/v2/${cepLimpo}`)
                .then(response => {
                    if (!response.ok) throw new Error('CEP não encontrado ou erro na API');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('endereco').value = data.street || '';
                    document.getElementById('bairro').value = data.neighborhood || '';
                    document.getElementById('cidade').value = data.city || '';
                    document.getElementById('cep-error').textContent = '';
                })
                .catch(error => {
                    console.error('Erro ao buscar CEP:', error);
                    document.getElementById('cep-error').textContent = error.message;
                });
        }

        // Inicialização dos componentes quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            initMapAdotante(); // Inicializa o mapa do adotante
            // Lógica para mostrar/esconder campos de "outros animais"
            if (document.getElementById('tem_outros_animais_sim')?.checked) {
                mostrarCamposOutrosAnimais();
            } else {
                esconderCamposOutrosAnimais();
            }
        });
    </script>
{% endblock %}